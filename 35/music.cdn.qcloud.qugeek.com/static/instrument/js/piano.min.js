!function(e){function t(e,t){this.el=e,this.options=extend({},this.options),extend(this.options,t),this.keyboard=this.el.querySelector("svg.piano__inner"),this.naturalKeys=[].slice.call(this.keyboard.querySelectorAll(".piano__keys--natural > rect")),this.flatKeys=[].slice.call(this.keyboard.querySelectorAll(".piano__keys--flat > rect")),this.allkeys=this.naturalKeys.concat(this.flatKeys),this.naturalKeysTotal=this.naturalKeys.length,this.flatKeysTotal=this.flatKeys.length,this.midiCode=0,this._init()}t.prototype.options={layouts:{keys:{default:{keys:[1,52],keyboardMapping:{q:15,w:17,e:19,r:20,t:22,y:24,u:26,i:27,o:29,p:31,a:32,s:34,d:36,f:38,g:39,h:41,j:43,k:44,l:46,z:48,x:50,c:51,v:53,b:55,n:56,m:58,",":60,".":62,"-":63,1:16,2:18,3:21,4:23,5:25,6:28,7:30,8:33,9:35,0:37,"'":40}},large:{keys:[24,45],keyboardMapping:{y:39,u:41,i:43,o:44,p:46,a:48,s:50,d:51,f:53,g:55,h:56,j:58,k:60,l:62,z:63,x:65,c:67,v:68,b:70,n:72,m:74,",":75,1:40,2:42,3:45,4:47,5:49,6:52,7:54,8:57,9:59,0:61,"'":64,q:66,w:69,e:71,r:73,t:76}},medium:{keys:[24,38],keyboardMapping:{q:39,w:41,e:43,r:44,t:46,y:48,u:50,i:51,o:53,p:55,a:56,s:58,d:60,f:62,g:63,1:40,2:42,3:45,4:47,5:49,6:52,7:54,8:57,9:59,0:61,"'":64}},small:{keys:[24,31],keyboardMapping:{q:39,w:41,e:43,r:44,t:46,y:48,u:50,i:51,1:40,2:42,3:45,4:47,5:49,6:52}}},mediaQueries:[{key:"screen and (min-width:120em)",type:"default"},{key:"screen and (min-width:50em) and (max-width:120em)",type:"large"},{key:"screen and (min-width:30em) and (max-width:50em)",type:"medium"},{key:"screen and (min-width:0) and (max-width:30em)",type:"small"}]}},t.prototype._init=function(){var e=this;this.keysRange=this.options.layouts.keys.default.keys,this.keyboardMapping=this.options.layouts.keys.default.keyboardMapping,this._assignKeyboard();for(var t=0,s=this.options.layouts.mediaQueries.length;t<=s-1;++t){!function(t,s,i){enquire.register(s,{match:function(){e.keysRange=e.options.layouts.keys[i].keys,e._validateKeysRange(),e._resetKeyboardMappingEv(e.options.layouts.keys[i].keyboardMapping)}})}(0,this.options.layouts.mediaQueries[t].key,this.options.layouts.mediaQueries[t].type)}this._validateKeysRange(),this._layout(),this._initEvents()},t.prototype._validateKeysRange=function(){this.keysInterval={from:this.keysRange[0],to:this.keysRange[1]},(this.keysInterval.from<1||this.keysInterval.from>this.naturalKeysTotal)&&(this.keysInterval.from=1),(this.keysInterval.to<1||this.keysInterval.to>this.naturalKeysTotal)&&(this.keysInterval.to=this.naturalKeysTotal)},t.prototype._layout=function(){this.dimensions={width:this.el.offsetWidth,height:this.el.offsetHeight};var e=this.keysInterval.to-this.keysInterval.from+1,t=this.naturalKeysTotal*this.dimensions.width/(this.keysInterval.to-this.keysInterval.from+1),s=-1*(this.keysInterval.from-1)*this.dimensions.width/e;this.keyboard.style.width=t+"px",this.keyboard.style.left=s+"px"},t.prototype._initEvents=function(){var t=this,s=mobilecheck(),i={down:s?"touchstart":"mousedown",up:s?"touchend":"mouseup"};this.allkeys.forEach(function(e){e.addEventListener(i.down,function(i){var a=i.target.getAttribute("note:id");t.mdown=!0,s||(t.mouseLeaveFn=function(e){t._play(a,"off"),t._changeKeyStatus(a),this.removeEventListener("mouseleave",t.mouseLeaveFn)},e.addEventListener("mouseleave",t.mouseLeaveFn)),t._play(a,"on"),t._changeKeyStatus(a)}),e.addEventListener(i.up,function(e){if(!t.mdown&&!s)return!1;t.mdown=!1;var i=e.target.getAttribute("note:id");s||this.removeEventListener("mouseleave",t.mouseLeaveFn),t._play(i,"off"),t._changeKeyStatus(i)}),s||e.addEventListener("mouseenter",function(s){if(!t.mdown)return!1;var i=s.target.getAttribute("note:id");t.mouseLeaveFn=function(e){t._play(i,"off"),t._changeKeyStatus(i),this.removeEventListener("mouseleave",t.mouseLeaveFn)},e.addEventListener("mouseleave",t.mouseLeaveFn),t._play(i,"on"),t._changeKeyStatus(i)})}),s||this.el.addEventListener("mouseleave",function(e){t.mdown=!1}),this.debounceResize=debounce(function(e){t._layout()},10),e.addEventListener("resize",this.debounceResize)},t.prototype._resetKeyboardMappingEv=function(e){Mousetrap.reset(),this.keyboardMapping=e,this._assignKeyboard()},t.prototype._assignKeyboard=function(){var e=this,t=[];for(var s in this.keyboardMapping){var i=this.keyboardMapping[s];!function(i){Mousetrap.bind(s,function(s){var a=s.key.toLowerCase();t[a]||(t[a]=!0,e._play(i,"on"),e._changeKeyStatus(i))},"keydown")}(i),function(i){Mousetrap.bind(s,function(s){var a=s.key.toLowerCase();t[a]&&(t[a]=!1,e._play(i,"off"),e._changeKeyStatus(i))},"keyup")}(i)}},t.prototype._play=function(e,t){e=parseInt(e)+21;MIDI.programChange(0,this.midiCode),"on"===t?MIDI.noteOn(0,e,127,0):MIDI.noteOff(0,e,.5)},t.prototype._getKeyByNote=function(e){for(var t=this.allkeys[0],s=0,i=this.allkeys.length;s<=i-1;++s)if(this.allkeys[s].getAttribute("note:id")==e){t=this.allkeys[s];break}return t},t.prototype._changeKeyStatus=function(e){var t=this._getKeyByNote(e);t.classList.contains("piano__key--active")?t.classList.remove("piano__key--active"):t.classList.add("piano__key--active")},e.Piano=t}(window);